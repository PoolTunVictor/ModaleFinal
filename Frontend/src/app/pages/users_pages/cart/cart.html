<!-- üî¥ BANNER GLOBAL -->
<app-banner
  title="CARRITO"
  subtitle="Todo lo que compraste, organizado para ti">
</app-banner>

<section class="cart-page">
  <div class="cart-layout">

    <!-- ================= LISTA ================= -->
    <div class="cart-list" *ngIf="cartItems.length > 0; else emptyCart">

      <div class="cart-header">
        <span>PRODUCTO</span>
        <span>CANTIDAD</span>
        <span>PRECIO</span>
        <span>TOTAL</span>
      </div>

      <div class="cart-item" *ngFor="let item of cartItems">

        <!-- PRODUCTO -->
        <div class="product-info">
          <img
            [src]="item.product.main_image || 'assets/no-image.png'"
            class="cart-product-img"
            alt="{{ item.product.name }}"
          />

          <div>
            <strong>{{ item.product.name }}</strong>
            <p class="product-price">${{ item.product.price }}</p>

            <button
              class="remove"
              (click)="cartService.remove(item)">
              Eliminar
            </button>
          </div>
        </div>

        <!-- CANTIDAD -->
        <div class="quantity-control">
          <button (click)="cartService.decrease(item)">‚àí</button>
          <span>{{ item.quantity }}</span>
          <button (click)="cartService.increase(item)">+</button>
        </div>

        <!-- PRECIO -->
        <div class="price">
          ${{ item.product.price }}
        </div>

        <!-- TOTAL -->
        <div class="total">
          ${{ item.product.price * item.quantity }}
        </div>

      </div>
    </div>

    <!-- ================= RESUMEN ================= -->
    <div class="summary">

      <h3>DETALLE DEL PEDIDO</h3>

      <!-- üî¥ NO LOGUEADO -->
      <div *ngIf="!isLoggedIn">
        <p>
          Para guardar la direcci√≥n y continuar con tu compra
          primero debes registrarte o iniciar sesi√≥n.
        </p>

        <button class="checkout-btn" (click)="goToLogin()">
          Ir a registro
        </button>
      </div>

      <!-- üü¢ LOGUEADO -->
      <ng-container *ngIf="isLoggedIn">

        <!-- ‚è≥ CARGANDO -->
        <p *ngIf="isLoadingAddresses">
          Cargando direcciones...
        </p>

        <!-- üî¥ SIN DIRECCIONES -->
        <div *ngIf="!isLoadingAddresses && addresses.length === 0">

          <p>No tienes direcciones guardadas.</p>

          <button
            class="checkout-btn"
            (click)="showAddressForm = true">
            Agregar direcci√≥n
          </button>

          <!-- FORMULARIO -->
          <div *ngIf="showAddressForm" class="address-form">
            <input placeholder="Nombre del receptor" [(ngModel)]="newAddress.receiver_name">
            <input placeholder="Tel√©fono" [(ngModel)]="newAddress.phone">
            <input placeholder="Calle" [(ngModel)]="newAddress.street">
            <input placeholder="Ciudad" [(ngModel)]="newAddress.city">
            <input placeholder="Estado" [(ngModel)]="newAddress.state">
            <input placeholder="C√≥digo postal" [(ngModel)]="newAddress.postal_code">
            <input placeholder="Referencias" [(ngModel)]="newAddress.references">

            <button
              class="checkout-btn"
              (click)="saveAddress()">
              Guardar direcci√≥n
            </button>
          </div>
        </div>

        <!-- üü¢ USUARIO LOGUEADO CON DIRECCIONES -->
        <div>

          <label>Direcci√≥n de env√≠o</label>
          <select [(ngModel)]="selectedAddressId">
            <option [ngValue]="null">Selecciona una direcci√≥n</option>

            <option
              *ngFor="let address of addresses"
              [ngValue]="address.id">
              {{ address.street }}, {{ address.city }}
            </option>
          </select>

          <!-- ‚ûï AGREGAR OTRA DIRECCI√ìN -->
          <button
            type="button"
            class="add-address-btn"
            (click)="showAddressForm = !showAddressForm">
            ‚ûï Agregar otra direcci√≥n
          </button>

          <!-- üìù FORMULARIO INLINE -->
          <div *ngIf="showAddressForm" class="address-form">

            <input placeholder="Nombre del receptor" [(ngModel)]="newAddress.receiver_name">
            <input placeholder="Tel√©fono" [(ngModel)]="newAddress.phone">
            <input placeholder="Calle" [(ngModel)]="newAddress.street">
            <input placeholder="Ciudad" [(ngModel)]="newAddress.city">
            <input placeholder="Estado" [(ngModel)]="newAddress.state">
            <input placeholder="C√≥digo postal" [(ngModel)]="newAddress.postal_code">
            <input placeholder="Referencias" [(ngModel)]="newAddress.references">

            <button
              class="checkout-btn"
              (click)="saveAddress()">
              Guardar direcci√≥n
            </button>
          </div>

          <!-- TOTAL -->
          <div class="summary-total">
            <span>Total</span>
            <strong>${{ getTotal() }}</strong>
          </div>

          <button
            class="checkout-btn"
            (click)="generateOrder()">
            GENERAR PEDIDO
          </button>

        </div>


      </ng-container>

      <a class="continue" routerLink="/">
        Contin√∫a comprando ‚Üí
      </a>

    </div>

  </div>
</section>

<!-- ================= CARRITO VAC√çO ================= -->
<ng-template #emptyCart>
  <p class="empty-cart">
    Tu carrito est√° vac√≠o üõí
  </p>
</ng-template>
